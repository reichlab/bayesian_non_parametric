library(dlm)
library(ggplot2)
library(forecast)
library(np)
require(rnn)
library(quantmod)
library(RSNNS)
Sys.setenv(PATH = paste("/Users/gcgibson/anaconda/bin", Sys.getenv("PATH"), sep=":"))


start_run <-650
sanJuanDengueData <- c(4,5,4,3,6,2,4,5,10,6,8,2,6,17,23,13,21,28,24,20,40,27,42,33,43,37,57,71,44,56,53,52,47,26,27,21,21,26,34,37,17,19,25,18,21,17,17,16,16,15,23,16,17,12,17,10,15,19,21,14,18,13,14,18,23,25,62,60,76,66,64,68,89,92,140,116,142,129,140,140,127,129,169,141,108,78,70,81,104,90,85,55,53,65,33,38,59,40,37,29,30,30,28,23,24,29,26,23,20,19,20,26,29,31,28,26,32,35,33,30,52,59,67,65,74,70,61,53,76,61,57,44,34,47,60,60,53,36,31,30,32,28,33,33,35,22,13,13,21,17,11,8,8,6,6,7,12,17,10,10,18,19,12,22,12,21,18,16,16,22,17,25,23,12,25,28,27,18,23,23,29,38,36,43,46,31,25,40,31,38,30,22,31,26,35,36,39,25,31,37,33,25,24,18,23,13,18,14,17,22,13,24,31,34,31,31,38,49,42,49,55,80,84,72,89,115,179,202,272,302,395,426,461,381,333,353,410,364,359,288,221,149,112,154,91,72,56,46,37,26,17,17,20,11,7,16,14,16,5,2,6,5,4,3,4,16,8,7,10,14,7,9,11,23,17,19,24,17,28,40,33,31,33,29,30,36,48,40,28,36,19,34,23,17,17,23,14,20,13,23,20,16,16,23,14,15,4,5,5,11,11,7,4,6,5,2,4,2,4,6,6,4,6,11,16,9,12,13,27,21,19,17,24,27,30,29,25,35,33,30,29,31,29,22,27,24,26,29,22,33,24,30,20,17,24,28,18,13,9,14,11,11,19,10,8,8,9,3,7,14,4,9,14,7,9,3,3,14,12,10,21,26,47,42,31,34,33,52,56,70,112,70,47,48,49,66,56,61,67,64,68,49,50,56,75,63,62,41,50,34,31,38,30,32,26,30,36,35,46,48,44,51,59,71,102,128,127,150,191,256,329,263,220,204,181,99,54,80,102,127,73,68,64,55,67,84,85,67,73,89,68,59,56,77,75,47,50,42,28,37,37,27,12,15,22,8,15,17,10,9,11,20,13,11,16,11,7,17,14,13,15,30,25,40,44,25,21,48,56,60,45,55,32,46,61,42,37,43,34,40,25,16,17,17,16,23,18,18,9,7,7,4,3,2,8,3,1,1,2,3,3,2,0,0,2,2,0,6,3,6,2,3,2,4,5,2,9,2,4,8,6,3,11,14,15,20,9,20,28,38,30,30,23,16,22,28,14,17,20,17,10,13,20,9,18,9,8,19,11,4,6,6,8,13,8,8,5,16,12,11,18,10,22,14,16,18,27,38,35,41,51,65,55,54,62,64,56,65,71,75,71,72,47,27,35,25,19,37,38,34,26,19,18,22,16,18,6,12,6,6,3,7,6,1,3,2,2,1,10,3,3,1,1,2,6,3,3,5,4,7,6,5,7,6,4,4,7,9,5,5,10,6,13,6,5,5,9,3,6,11,7,7,15,9,6,6,6,7,10,8,7,12,3,2,7,5,5,7,7,7,7,10,13,10,14,11,20,25,17,18,25,21,31,32,26,35,28,37,41,34,30,39,39,39,34,30,37,29,26,15,22,15,20,14,10,21,14,14,9,11,5,6,7,11,4,3,2,6,10,7,5,3,12,13,10,13,13,8,21,18,8,7,20,14,14,7,14,10,13,27,13,18,16,16,20,17,4,15,8,6,12,15,11,10,15,17,7,7,8,9,12,12,5,4,11,4,5,7,1,1,4,2,6,3,4,10,12,21,26,21,30,45,56,75,83,82,126,119,137,131,112,82,73,43,55,55,53,46,43,29,22,26,13,17,8,13,10,17,19,9,9,9,3,7,7,0,2,3,3,1,3,3,3,7,3,5,11,5,5,6,6,4,4,8,14,12,16,10,16,18,15,23,17,33,15,13,11,14,17,19,20,12,21,7,19,10,13,10,8,21,11,9,14,14,15,18,16,12,20,8,3,13,4,1,10,8,13,10,21,18,21,34,25,34,33,40,42,36,72,75,76,92,71,112,106,101,170,135,106,68,48,48,26,33,29,17,12,13,17,15,14,15,10,9,2,6,8,5,1,2,3,4,3,1,3,5,2,3,2,3,2,2,3,4,3,4,4,4,7,6,15,11,9,9,12,13,13,13,20,28,45,28,34,41,36,38,48,27,23,28,42,30,18,38,28,36,44,41,35,28,28,22,26,24,9,21,10,15)
monthly_temp <- c(184.99999999999997, 188.70000000000002, 189.6, 201.9, 199.10000000000002, 191.90000000000003, 197.39999999999998, 199.20000000000002, 196.29999999999998, 194.9, 196.0, 196.8, 196.4, 198.5, 198.20000000000002, 196.2, 200.29999999999998, 198.89999999999998, 200.5, 198.3, 198.4, 201.1, 199.8, 195.1, 187.4, 194.7, 199.5, 193.7, 188.1, 183.8, 183.20000000000002, 173.29999999999998, 179.6, 177.1, 174.1, 174.6, 175.7, 175.5, 171.2, 176.3, 175.2, 182.2, 175.49999999999997, 181.5, 183.4, 181.60000000000002, 181.8, 177.3, 177.60000000000002, 178.79999999999998, 182.5, 192.0, 188.49999999999997, 185.9, 191.5, 195.3, 195.20000000000002, 198.10000000000002, 202.4, 194.3, 200.29999999999998, 198.7, 201.79999999999998, 195.8, 200.0, 198.9, 205.1, 204.89999999999998, 198.0, 200.9, 204.7, 203.0, 196.8, 194.70000000000005, 194.10000000000002, 198.79999999999998, 195.3, 197.10000000000002, 190.29999999999998, 187.5, 184.10000000000002, 184.2, 187.10000000000002, 180.10000000000002, 176.4, 171.4, 168.5, 179.3, 179.29999999999998, 173.0, 174.60000000000002, 172.29999999999998, 181.29999999999998, 180.60000000000002, 177.79999999999998, 178.8, 180.4, 182.4, 182.6, 184.79999999999998, 186.70000000000002, 189.30000000000004, 186.5, 188.70000000000002, 190.9, 191.0, 194.70000000000002, 192.0, 192.2, 197.4, 197.79999999999998, 197.9, 204.6, 201.1, 194.9, 193.9, 194.79999999999998, 196.1, 194.10000000000002, 196.9, 198.2, 200.0, 197.8, 196.2, 193.5, 195.40000000000003, 201.1, 204.09999999999997, 201.7, 199.6, 201.20000000000002, 192.3, 187.9, 190.70000000000002, 186.9, 189.29999999999998, 185.39999999999998, 182.6, 181.79999999999998, 180.5, 172.89999999999998, 173.4, 171.89999999999998, 184.2, 178.1, 185.0, 180.6, 177.9, 174.1, 187.60000000000002, 184.69999999999996, 185.50000000000003, 191.4, 190.2, 180.7, 191.9, 188.60000000000002, 187.0, 192.79999999999998, 205.70000000000002, 192.70000000000002, 208.9, 194.5, 191.4, 201.49999999999997, 198.1, 195.7, 198.4, 195.8, 202.1, 204.1, 206.2, 202.49999999999997, 200.8, 199.4, 199.59999999999997, 197.1, 199.10000000000002, 195.60000000000002, 198.5, 197.70000000000002, 196.50000000000003, 195.49999999999997, 193.3, 191.0, 188.2, 187.7, 185.7, 184.2, 182.4, 182.39999999999998, 178.8, 178.7, 175.1, 177.0, 181.50000000000003, 176.4, 179.9, 179.89999999999998, 177.2, 180.60000000000002, 181.5, 185.39999999999998, 187.50000000000003, 185.2, 181.79999999999998, 181.8, 185.29999999999998, 193.7, 193.10000000000002, 193.40000000000003, 202.29999999999998, 201.2, 197.8, 197.70000000000002, 196.0, 199.0, 196.20000000000002, 196.3, 199.20000000000005, 198.79999999999998, 198.3, 198.5, 199.0, 199.1, 205.7, 204.6, 200.3, 200.0, 195.3, 200.50000000000003, 200.5, 200.0, 192.6, 197.9, 193.2, 187.9, 197.3, 186.99999999999997, 185.20000000000002, 186.6, 186.2, 187.5, 182.40000000000003, 180.70000000000002, 174.29999999999998, 181.6, 179.1, 180.8, 186.7, 182.3, 177.1, 178.2, 179.6, 168.70000000000002, 178.89999999999998, 178.79999999999998, 191.3, 187.4, 184.29999999999998, 191.9, 196.79999999999998, 189.89999999999998, 188.1, 194.7, 191.1, 192.7, 201.29999999999998, 206.0, 206.7, 203.9, 204.6, 200.4, 200.9, 203.00000000000003, 210.0, 200.1, 202.7, 207.50000000000003, 205.9, 204.9, 210.79999999999998, 198.9, 198.7, 194.1, 192.9, 196.8, 191.5, 189.7, 191.0, 190.6, 189.1, 186.89999999999998, 181.6, 188.5, 188.5, 183.00000000000003, 183.5, 179.1, 174.2, 175.9, 176.1, 182.39999999999998, 178.3, 179.60000000000002, 181.7, 185.10000000000002, 183.6, 182.1, 182.8, 184.0, 182.0, 183.3, 177.79999999999998, 180.90000000000003, 186.2, 195.79999999999998, 194.70000000000002, 190.3, 184.2, 192.6, 196.20000000000002, 198.1, 189.70000000000002, 191.8, 190.8, 193.1, 195.5, 188.7, 194.29999999999998, 197.7, 198.2, 188.9, 193.10000000000002, 193.39999999999998, 190.2, 193.0, 202.10000000000002, 194.0, 185.2, 184.2, 182.20000000000002, 178.2, 176.5, 173.10000000000002, 176.3, 170.4, 176.6, 172.4, 170.79999999999998, 173.5, 172.70000000000002, 166.9, 171.4, 173.1, 171.60000000000002, 172.3, 170.2, 172.70000000000002, 177.1, 175.2, 178.20000000000002, 178.8, 192.7, 194.9, 195.8, 191.9, 194.20000000000002, 190.6, 192.1, 198.79999999999998, 202.49999999999997, 201.20000000000002, 198.9, 202.2, 201.2, 197.0, 192.7, 200.3, 198.59999999999997, 198.2, 196.2, 200.9, 202.1, 203.7, 199.1, 191.39999999999998, 199.8, 192.89999999999998, 193.9, 197.6, 195.6, 190.8, 191.9, 190.79999999999998, 186.4, 188.89999999999998, 184.09999999999997, 187.79999999999998, 186.79999999999998, 185.6, 174.5, 178.4, 184.7, 186.99999999999997, 191.80000000000004, 171.20000000000002, 182.5, 180.5, 180.1, 175.0, 181.59999999999997, 182.20000000000002, 179.2, 191.10000000000002, 177.8, 188.29999999999998, 186.70000000000002, 188.0, 198.0, 193.99999999999997, 194.5, 200.4, 195.6, 198.29999999999998, 199.5, 199.29999999999998, 198.1, 193.7, 198.19999999999996, 198.0, 203.59999999999997, 204.4, 199.20000000000002, 197.9, 199.20000000000002, 201.00000000000003, 196.2, 194.8, 197.5, 194.8, 196.6, 193.5, 193.0, 195.20000000000002, 186.4, 186.0, 180.0, 181.3, 180.8, 183.20000000000002, 178.5, 179.2, 176.29999999999998, 174.39999999999998, 174.70000000000002, 170.90000000000003, 163.0, 169.39999999999998, 168.0, 174.6, 175.4, 172.29999999999998, 180.3, 180.2, 179.79999999999998, 176.9, 187.3, 187.60000000000002, 195.2, 191.20000000000002, 193.3, 198.5, 199.39999999999998, 195.7, 192.70000000000002, 190.79999999999998, 198.8, 193.79999999999998, 190.1, 186.0, 196.20000000000002, 198.60000000000002, 196.6, 198.79999999999998, 197.3, 195.0, 198.1, 199.29999999999998, 198.8, 202.20000000000002, 195.20000000000002, 191.6, 186.70000000000002, 193.1, 193.79999999999995, 187.29999999999998, 188.5, 183.9, 184.99999999999997, 174.8, 174.29999999999998, 174.7, 175.0, 175.3, 175.9, 167.2, 158.6, 175.0, 175.1, 175.9, 173.9, 172.5, 167.4, 175.00000000000003, 175.0, 169.4, 178.89999999999998, 180.3, 181.49999999999997, 186.8, 190.5, 186.5, 186.00000000000003, 188.8, 191.2, 195.00000000000003, 197.6, 190.60000000000002, 194.9, 195.0, 197.29999999999998, 200.89999999999998, 196.60000000000002, 198.4, 197.0, 201.2, 199.9, 191.5, 196.1, 197.6, 194.0, 192.70000000000002, 193.8, 195.0, 196.90000000000003, 191.2, 191.9, 182.8, 183.7, 187.2, 185.00000000000003, 187.09999999999997, 182.79999999999998, 178.20000000000002, 177.9, 178.9, 177.7, 176.29999999999998, 174.20000000000002, 178.1, 173.09999999999997, 177.6, 175.0, 172.5, 171.0, 187.79999999999998, 183.9, 180.7, 190.39999999999998, 184.6, 185.4, 191.79999999999998, 186.7, 193.29999999999998, 193.10000000000002, 201.4, 198.8, 197.0, 199.39999999999998, 194.9, 200.4, 196.2, 199.19999999999996, 196.9, 199.8, 197.5, 195.8, 198.8, 202.5, 199.1, 195.5, 197.5, 196.8, 196.7, 202.1, 201.10000000000002, 191.2, 192.20000000000002, 195.8, 187.9, 186.1, 186.3, 184.70000000000002, 177.0, 183.7, 180.00000000000003, 180.3, 175.0, 178.79999999999998, 176.5, 183.7, 180.70000000000002, 175.3, 176.3, 180.5, 177.0, 177.6, 180.9, 180.20000000000002, 185.9, 184.40000000000003, 190.2, 179.8, 177.89999999999998, 186.1, 184.9, 182.70000000000002, 192.20000000000002, 198.4, 196.79999999999998, 199.60000000000002, 201.0, 192.9, 198.0, 197.1, 198.6, 197.9, 197.7, 200.1, 201.0, 196.3, 200.8, 192.70000000000002, 202.19999999999996, 202.8, 196.20000000000002, 193.6, 197.3, 192.8, 195.89999999999998, 192.8, 191.5, 191.7, 191.7, 188.0, 185.6, 183.00000000000003, 181.8, 179.6, 179.8, 177.7, 181.1, 179.3, 177.0, 176.2, 178.49999999999997, 177.8, 180.3, 177.20000000000002, 183.8, 185.5, 187.70000000000002, 188.1, 184.70000000000002, 184.4, 178.2, 186.79999999999998, 194.3, 188.89999999999998, 188.2, 193.20000000000002, 197.5, 190.6, 192.9, 195.4, 200.5, 195.7, 193.40000000000003, 196.7, 196.9, 195.1, 196.0, 197.50000000000003, 194.89999999999998, 193.3, 201.1, 199.89999999999998, 199.3, 199.4, 196.70000000000002, 189.9, 196.70000000000005, 194.29999999999998, 191.4, 191.10000000000002, 185.0, 182.70000000000002, 183.00000000000003, 180.0, 179.8, 182.4, 177.3, 170.4, 169.89999999999998, 172.2, 172.70000000000002, 174.1, 173.9, 175.9, 171.2, 174.39999999999998, 177.4, 181.79999999999998, 178.3, 175.29999999999998, 175.3, 182.10000000000002, 180.9, 182.79999999999998, 184.20000000000002, 185.7, 183.1, 174.79999999999998, 192.1, 197.70000000000002, 197.39999999999998, 197.6, 198.79999999999998, 195.3, 198.0, 194.6, 197.2, 198.9, 202.8, 201.90000000000003, 203.7, 201.5, 202.29999999999998, 200.2, 190.0, 205.5, 196.8, 197.50000000000003, 198.0, 193.6, 189.7, 190.9, 184.7, 185.10000000000002, 179.5, 176.4, 183.09999999999997, 183.6, 180.1, 174.89999999999998, 175.8, 177.4, 165.8, 168.20000000000002, 162.3, 162.8, 172.0, 174.09999999999997, 181.6, 181.20000000000002, 183.6, 191.89999999999998, 191.10000000000002, 192.0, 197.79999999999998, 186.4, 192.5, 190.2, 185.10000000000002, 197.8, 199.9, 202.5, 192.9, 207.7, 205.3, 202.0, 201.10000000000002, 197.0, 201.9, 203.99999999999997, 204.89999999999998, 205.89999999999998, 195.79999999999998, 196.5, 201.8, 204.1, 201.20000000000005, 199.9, 199.5, 187.4, 193.5, 197.20000000000002, 196.3, 195.59999999999997, 190.6, 186.4, 184.10000000000002, 174.89999999999998, 179.0, 172.9, 171.0, 171.8, 168.7, 174.6, 169.5, 163.60000000000002, 167.1, 172.40000000000003, 174.3, 176.9, 178.39999999999998, 178.3, 180.1, 185.10000000000002, 179.2, 180.10000000000002, 187.2, 184.20000000000002, 186.0, 179.89999999999998, 194.40000000000003, 201.79999999999998, 201.79999999999998, 200.20000000000002, 204.3, 195.8, 194.29999999999998, 197.09999999999997, 196.6, 191.5, 198.2, 195.4, 192.9, 199.60000000000002, 195.7, 197.4, 199.49999999999997, 198.89999999999998, 201.6, 204.0, 202.10000000000002, 201.4, 197.4, 197.90000000000003, 198.9, 196.79999999999998, 191.39999999999998, 187.1, 194.1, 182.8, 185.10000000000002, 181.5, 182.3, 177.8, 175.7, 174.5, 175.5, 175.79999999999998, 178.20000000000002, 182.79999999999998, 184.69999999999996, 178.5, 187.0, 186.8, 186.8, 190.79999999999998, 180.8, 182.7, 192.8, 192.8, 179.9, 190.5, 201.89999999999998, 201.8, 198.9, 203.8, 200.7, 202.8, 204.9, 201.6, 201.3, 202.20000000000002, 199.39999999999998, 201.3, 199.79999999999998, 197.8, 199.7, 199.6, 197.70000000000002, 200.9, 199.3, 197.20000000000002, 195.3, 196.89999999999998, 203.6, 196.90000000000003, 184.6, 192.6, 186.3, 190.2, 177.29999999999998, 180.9, 181.20000000000002, 175.00000000000003, 176.2, 177.7, 175.1, 170.70000000000002, 173.7, 170.20000000000002, 169.79999999999998, 173.1, 174.5, 173.5, 175.8, 176.8, 176.4, 174.79999999999998, 183.4, 176.0, 176.5, 188.2, 186.5, 182.8, 192.1, 197.50000000000003, 192.5, 197.1, 191.50000000000003, 199.4, 202.79999999999998, 198.29999999999998, 194.6, 200.4, 200.5, 202.29999999999998, 199.9, 203.7, 203.29999999999998, 203.79999999999998, 204.0, 198.7, 197.6, 195.2, 195.5, 197.20000000000002, 193.7, 185.2, 194.7, 193.29999999999998, 191.7, 188.6, 184.8, 178.5, 178.1, 183.39999999999998, 176.8, 178.59999999999997, 174.20000000000002, 181.8, 179.59999999999997, 184.70000000000002, 178.4, 179.7, 173.5, 176.8, 179.2, 179.6, 175.79999999999998, 176.6, 174.70000000000002, 179.2)
#sanJuanDengueData <- c(0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,2,4,1,4,11,16,023,12,14,18,8,7,10,7,10,5,11,8,18,13,9,22,10,5,13,2,11,11,3,7,7,4,5,6,7,7,4,9,17,8,22,18,21,16,231,25,28,26,218,627,11,638,29,21,11,10,5,6,2,1,2,2,3,5,1,4,2,4,0,0,0,0,1,1,1,1,1,2,3,4,6,2,2,5,1,1,0,0,0,0,2,0,3,0,0,0,2,2,3,3,3,1,2,3,6,5,1,4,5,8,5,2,3,3,1,6,4,1,2,3,1,8,4,6,7,5,8,6,5,6,6,13,2,10,3,12,7,6,5,6,6,6,8,6,9,12,19,8,16,21,6,22,437,33,18,983,7116,32,7,9,10,5,8,7,8,11,6,7,7,14,7,9,13,16,7,9,2,13,8,3,5,4,8,2,3,5,7,3,5,6,5,5,4,0,0,0,0,0,2,4,4,3,3,5,6,14,3,7,11,2,6,8,125,21,10,28,439,120,24,28,26,8,9,12,18,9,9,6,6,8,5,7,6,5,3,1,0,1,2,3,2,2,2,2,2,4,0,6,3,2,6,2,7,4,6,6,2,13,10,5,2,0,1,0,14,6,10,5,12,9,5,11,2,6,7,6,5,9,5,8,3,4,11,5,8,4,3,1,2,3,4,1,8,5,3,2,7,1,6,7,5,2,6,11,6,3,11,11,5,4,9,23,28,26,7,29,258,26,38,35,37,20,29,25,23,9,3,6,6,3,1,3,1,1,0,2,1,1,0,0,1,0,3,3,1,5,2,5,5,5,9,17,19,25,445,034,063,44,50,235,16,16,13,9,15,4,0,1,10,11,29,35,30,20,21,12,9,11,9,5,11,3,5,5,4,4,1,0,2,3,3,5,2)
#sanJuanDengueData <- sin(seq(1:1000))+10
sanJuanDengueDataTrainTS <- ts(sanJuanDengueData[seq(1,start_run)], start = 1, frequency = 1)
sarimaFit <- auto.arima(sanJuanDengueDataTrainTS)




n_ahead <- 10


lagged_4 <- cbind(Lag(sanJuanDengueData[seq(1,start_run-n_ahead)], k=3),Lag(sanJuanDengueData[seq(1,start_run-n_ahead)], k=2),
                  Lag(sanJuanDengueData[seq(1,start_run-n_ahead)], k=1),Lag(sanJuanDengueData[seq(1,start_run-n_ahead)], k=0))

lagged_4 <- matrix(lagged_4,ncol=4)[-1:-4,]

mlpFit <-rbf(lagged_4, sanJuanDengueData[seq(5+n_ahead,start_run)], size=50)
sarimaFit <- auto.arima(sanJuanDengueDataTrainTS)


ssm2 <- function(parm){
 # parm <- parm_rest(parm)
  return( dlmModARMA(ar =parm[1],ma=parm[2],sigma2=exp(parm[3])))
}

ssm1 <- function(parm){
  # parm <- parm_rest(parm)
  return( dlmModARMA(ar =parm[1],ma=parm[2],sigma2=exp(parm[3])))
        #+dlmModReg(monthly_temp[seq(1,start_run)]))
}
# estimate parameters
fit1 <- dlmMLE(y=sanJuanDengueDataTrainTS,parm=c(1,1,1,1),build=ssm1,hessian=T)
coef <- fit1$par


dlmForecasts <- c()
sarimaForecasts <-c()
kcdeForecasts <- c()
ukfForecasts <- c()
rnnForecasts <- c()


end_run <- start_run+52

for (run in start_run:end_run){
  print (start_run-n_ahead)
  print (run-n_ahead)
  sanJuanDengueDataTestTS <- ts(sanJuanDengueData[seq(start_run-n_ahead,run-n_ahead)], start = 100000, frequency = 52)
  
  rnn_point_forecast <-predict(mlpFit,sanJuanDengueData[seq(run-n_ahead-3,run-n_ahead)])
  
  rnnForecasts <- c(rnnForecasts,tail(rnn_point_forecast,n=1))
  sarimaForecasts<- tryCatch({
    sarimaFit <- Arima(sanJuanDengueDataTestTS,c(1,0,2),method="ML")
    sarimaForecast <- forecast(sarimaFit,h=n_ahead)
    c(sarimaForecasts,tail(sarimaForecast$mean,n=1))
  },
  error=function(cond){
    c(sarimaForecasts,0)
  })
  mod <- dlmModARMA(ar =coef[1],ma=coef[2],sigma2=exp(coef[3]))# + dlmModReg(monthly_temp[seq(start_run-n_ahead,run-n_ahead)])
  
  outF <- dlmFilter(sanJuanDengueData[seq(start_run-n_ahead,run-n_ahead)], mod)
  dlmfore <- dlmForecast(outF, nAhead = n_ahead)
  dlmForecasts <- c(dlmForecasts,tail(dlmfore$f,n=1))
}

output_length <- length(sarimaForecasts)
exec_str <- 'python /Users/gcgibson/Desktop/bayesian_non_parametric/dlm/ukf.py '
exec_str <- paste(exec_str,n_ahead)
exec_str <- paste(exec_str, ' ')
exec_str <- paste(exec_str, start_run)
exec_str <- paste(exec_str, ' ')
exec_str <- paste(exec_str, end_run)
ukf1 <- system(exec_str,intern=TRUE)
ukfResultVector <- strsplit(ukf1,",")
ukfResultVector <- as.numeric(unlist(ukfResultVector))

library(Metrics)
mse(dlmForecasts,sanJuanDengueData[seq(start_run ,end_run)])
mse(sarimaForecasts,sanJuanDengueData[seq(start_run ,end_run)])

p <- ggplot() + 
   geom_line(data=data.frame(x=1:output_length,y=dlmForecasts),aes(x,y,color='DLM'),size=.5) +
   geom_line(data=data.frame(x=1:output_length,y=sanJuanDengueData[seq(start_run,end_run)]),aes(x,y,color='True'),size=.5)+
   geom_line(data=data.frame(x=1:output_length,y=sarimaForecasts),aes(x,y,color='SARIMA'),size=.2)+
    geom_line(data=data.frame(x=1:(output_length-1),y=ukfResultVector),aes(x,y,color="ARD"),size=.2)+ 
   geom_line(data=data.frame(x=1:output_length,y=rnnForecasts),aes(x,y,color="RNN"),size=.2)+ 
#   
  coord_cartesian(ylim=c(-50,200)) +
  scale_fill_manual(values=c("#CC0000", "#006600", "#669999", "#00CCCC", 
                             "#660099", "#CC0066", "#FF9999", "#FF9900", 
                              "black", "black", "black", "black", "black"))
print (p)
